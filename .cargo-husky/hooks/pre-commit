#!/bin/sh -e
# This hook formats staged Rust files, then runs tests and clippy before each commit

echo "Running pre-commit checks..."

# Format staged Rust files and re-add them to the commit
echo "→ Checking for staged Rust files to format..."
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.rs$' || true)
if [ -n "$STAGED_RS_FILES" ]; then
    echo "→ Formatting staged Rust files..."
    # Format the whole workspace to ensure consistent formatting across modules
    cargo +nightly fmt --all
    # Re-add only the originally staged Rust files so they are included in this commit
    echo "$STAGED_RS_FILES" | while IFS= read -r file; do
        [ -n "$file" ] && git add -- "$file"
    done
fi

# Verify formatting is clean post-format
echo "→ Verifying code formatting..."
cargo +nightly fmt --all -- --check

# Run tests
echo "→ Running tests..."
cargo hack --workspace --feature-powerset test

# Run clippy
echo "→ Running clippy..."
cargo hack --workspace --feature-powerset clippy --all-targets -- -D warnings

echo "✓ All pre-commit checks passed!"
